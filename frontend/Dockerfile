# Stage 1: Build the project and package it into a .jar file.
FROM maven:3.8.4 as maven

WORKDIR .
COPY . .

ARG LOGIN_URL
ARG COURSE_MANAGER_URL
ARG COURSE_VIEWER_URL
ARG PEER_REVIEW_URL
ARG PROFESSOR_ASSIGNMENT_URL
ARG STUDENT_ASSIGNMENT
ARG STUDENT_PEER_REVIEW_ASSIGNMENT_URL
ARG CLIENT_ID

ENV REACT_APP_LOGIN_URL=$LOGIN_URL
ENV REACT_APP_COURSE_MANAGER_URL=$COURSE_MANAGER_URL
ENV REACT_APP_COURSE_VIEWER_URL=$COURSE_VIEWER_URL
ENV REACT_APP_PEER_REVIEW_URL=$PEER_REVIEW_URL
ENV REACT_APP_PROFESSOR_ASSIGNMENT_URL=$PROFESSOR_ASSIGNMENT_URL
ENV REACT_APP_STUDENT_ASSIGNMENT_URL=$STUDENT_ASSIGNMENT
ENV REACT_APP_STUDENT_PEER_REVIEW_ASSIGNMENT_URL=$STUDENT_PEER_REVIEW_ASSIGNMENT_URL
ENV REACT_APP_CLIENT_ID=$CLIENT_ID

RUN mvn package

# Stage 2: Copy the .jar file and server.xml into the required location.
FROM icr.io/appcafe/open-liberty:full-java11-openj9-ubi

# Copy from the intermediate build container.
COPY --from=maven src/main/liberty/config/server.xml /config/
COPY --from=maven target/*.war /config/apps